--CONSULTAS SOLICITACOES

SELECT usu.NM_USUARIO,
       usu.DS_OBSERVACAO AS DS_FUNCAO
FROM dbasgu.USUARIOS usu
WHERE usu.SN_ATIVO = 'S'
AND usu.CD_USUARIO = --VARIAVEL PHP

----------------------------------
--CONSULTAS SOLICITACOES ( C.A ) 

SELECT prod.CD_PRODUTO, prod.DS_PRODUTO, 
SUBSTR( prod.DS_PRODUTO,
    INSTR( prod.DS_PRODUTO, '(CA') + 1,
    INSTR( prod.DS_PRODUTO, ')') - INSTR( prod.DS_PRODUTO, '(CA') - 1) AS CA
FROM dbamv.PRODUTO prod
WHERE prod.DS_PRODUTO LIKE '%(CA %'
AND prod.TP_ATIVO = 'S'
ORDER BY 2 ASC

----------------------------------
--CONSULTAS SETOR 

SELECT st.CD_SETOR,
       st.NM_SETOR
FROM dbamv.SETOR st
WHERE st.SN_ATIVO = 'S'
ORDER BY st.CD_SETOR ASC, st.NM_SETOR ASC
----------------------------------
--INSERINDO DADOS LISTAGEM
INSERT INTO portal_sesmt.ITSOLICITACAO
SELECT 
'1'        AS CD_ITSOLICITACAO,
'12'       AS  CD_SOLICITACAO,
'123'      AS  CD_PRODUTO_MV,
'1234'     AS CA_MV,
'2'        AS QUANTIDADE,
'LDPGOMES'  AS CD_USUARIO_CADASTRO,
SYSDATE     AS HR_CADASTRO,
NULL        AS CD_USUARIO_ULT_ALT,
SYSDATE     AS HR_ULT_ALT
FROM DUAL
----------------------------------
-- TABELA RELATORIO

SELECT sol.CD_SOLICITACAO,
       sol.CD_USUARIO_MV,
       TO_CHAR(sol.HR_CADASTRO, 'DD/MM/YYYY') AS HR_CADASTRO,
       sol.CD_SETOR_MV,
       sol.CD_PRODUTO_MV,
       pro.DS_PRODUTO,
       sol.CA_MV,
       sol.QUANTIDADE,
       sol.CD_USUARIO_CADASTRO
FROM portal_sesmt.SOLICITACAO sol
INNER JOIN dbamv.PRODUTO pro
   ON pro.CD_PRODUTO = sol.CD_PRODUTO_MV
WHERE sol.CD_SETOR_MV = 186
AND TO_CHAR(sol.HR_CADASTRO,'DD/MM/YYYY') BETWEEN '26/09/2022' AND '26/09/2022'
AND sol.CD_USUARIO_MV = 'LDPGOMES'

---------------------------------------------------------------------------------
DELETE portal_sesmt.DURABILIDADE;

INSERT INTO portal_sesmt.DURABILIDADE 
SELECT 
portal_sesmt.SEQ_CD_DURABILIDADE.NEXTVAL AS CD_DURABILIDADE,
'50138' AS CD_PRODUTO_MV,
'S' AS SN_ATIVO,
'10' AS DIAS,
'LDPGOMES' AS CD_USUARIO_CADASTRO,
SYSDATE  AS HR_CADASTRO,
NULL  AS CD_USUARIO_ULT_ALT,
SYSDATE AS HR_ULT_ALT
FROM DUAL
 
